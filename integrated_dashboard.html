<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美股情绪看板 - 综合仪表盘</title>
    <link rel="stylesheet" href="chart.min.css">
    <style>
        :root {
            --optimistic-color: rgba(39, 174, 96, 0.7);
            --optimistic-light: rgba(39, 174, 96, 0.3);
            --neutral-color: rgba(243, 156, 18, 0.7);
            --neutral-light: rgba(243, 156, 18, 0.3);
            --pessimistic-color: rgba(231, 76, 60, 0.7);
            --pessimistic-light: rgba(231, 76, 60, 0.3);
            --missing-color: rgba(149, 165, 166, 0.7);
            --missing-light: rgba(149, 165, 166, 0.3);
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --card-radius: 10px;
            --card-padding: 20px;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .section {
            background-color: white;
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            padding: var(--card-padding);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        /* 情绪分布趋势图样式 */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        /* 情绪统计卡片样式 */
        .stats-cards {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            min-width: 200px;
            background-color: white;
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            padding: 15px;
            text-align: center;
            display: flex;
            flex-direction: column;
        }

        .stat-card h3 {
            margin-top: 0;
            font-size: 1.2em;
            color: #7f8c8d;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-card .trend {
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .stat-card .mini-chart {
            height: 60px;
            margin-top: auto;
            padding: 5px 0;
        }

        .trend-up {
            color: var(--optimistic-color);
        }

        .trend-neutral {
            color: var(--neutral-color);
        }

        .trend-down {
            color: var(--pessimistic-color);
        }

        /* 指标卡片网格样式 */
        .indicators-section {
            margin-top: 40px;
        }

        .indicators-grid {
            display: grid;
            /* 修改为两列，每列最小宽度为 450px，占据可用空间的 1 份 */
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .indicator-card {
            background-color: white;
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            padding: 15px;
            display: flex;
            flex-direction: column;
            min-height: 300px; /* 增加卡片高度20% (250px * 1.2 = 300px) */
            cursor: pointer; /* 添加指针样式，表示可点击 */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        /* 根据情绪判断设置卡片左边框色 */
        .indicator-card.optimistic {
            border-left: 4px solid var(--optimistic-color);
        }
        
        .indicator-card.neutral {
            border-left: 4px solid var(--neutral-color);
        }
        
        .indicator-card.pessimistic {
            border-left: 4px solid var(--pessimistic-color);
        }
        
        .indicator-card.missing {
            border-left: 4px solid var(--missing-color);
        }
        
        .indicator-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .indicator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .indicator-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #2c3e50;
        }

        .indicator-sentiment {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .sentiment-optimistic {
            background-color: var(--optimistic-light);
            color: #27ae60;
        }

        .sentiment-neutral {
            background-color: var(--neutral-light);
            color: #f39c12;
        }

        .sentiment-pessimistic {
            background-color: var(--pessimistic-light);
            color: #e74c3c;
        }

        .sentiment-missing {
            background-color: var(--missing-light);
            color: #7f8c8d;
        }

        .indicator-value {
            font-size: 1.8em;
            font-weight: bold;
            margin: 10px 0;
            color: #2c3e50;
        }
        
        .value-na {
            color: #999;
            font-size: 1.5rem;
            font-style: italic;
        }
        
        .indicator-explanation {
            margin-top: 10px;
            font-size: 0.9em;
            color: #34495e;
            line-height: 1.4;
            flex-grow: 1;
            overflow-y: auto;
            max-height: 100px;
        }
        
        .threshold-explanation {
            margin-top: 5px;
            font-size: 0.8em;
            color: #7f8c8d;
            font-style: italic;
            border-top: 1px dashed #ecf0f1;
            padding-top: 8px;
        }
        
        .detailed-explanation {
            font-size: 0.85em;
            color: #34495e;
            margin: 10px 0;
            line-height: 1.5;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #3498db;
            max-height: 300px;
            overflow-y: auto;
        }

        .mini-chart {
            height: 150px; /* 增加图表高度 */
            margin-top: auto;
            border-radius: 4px;
            overflow: hidden;
            padding: 10px 5px 5px 5px;
            border-top: 1px solid #eee;
        }
        
        /* 分类标题样式 */
        .category-title {
            margin: 30px 0 20px 0;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .category-title h2 {
            margin: 0;
            color: white;
            font-size: 1.3em;
            font-weight: 600;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .category-title:first-child {
            margin-top: 0;
        }
        
        /* 分类指标容器样式 */
        .category-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* 响应式布局 */
        /* 媒体查询，在小屏幕上依然保持单列 */
        @media (max-width: 960px) { /* 调整断点，适配两列布局 */
            .indicators-grid {
                grid-template-columns: 1fr; /* 小屏幕上变为单列 */
            }
            
            .category-indicators {
                grid-template-columns: 1fr; /* 小屏幕上分类指标也变为单列 */
            }
            
            .stats-cards {
                flex-direction: column;
            }

            .stat-card {
                width: 100%;
            }
        }
        
        @media (max-width: 600px) {
            .category-title {
                margin: 20px 0 15px 0;
                padding: 12px 15px;
            }
            
            .category-title h2 {
                font-size: 1.1em;
            }
            
            .category-indicators {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 美股情绪看板</h1>
            <p>综合分析美股市场情绪指标</p>
            <p id="lastUpdate">最后更新: 2025-07-15</p>
        </div>

        <!-- 情绪分布趋势图 -->
        <div class="section">
            <h2 class="section-title">情绪分布趋势</h2>
            <div class="chart-container">
                <canvas id="sentimentChart"></canvas>
            </div>
        </div>

        <!-- 情绪统计卡片 -->
        <div class="section">
            <h2 class="section-title">情绪指标统计</h2>
            <div class="stats-cards">
                <div class="stat-card">
                    <h3>乐观指标</h3>
                    <div class="value" id="optimisticValue">0</div>
                    <div class="trend" id="optimisticTrend">趋势: --</div>
                    <div class="mini-chart">
                        <canvas id="optimisticChart"></canvas>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>中性指标</h3>
                    <div class="value" id="neutralValue">0</div>
                    <div class="trend" id="neutralTrend">趋势: --</div>
                    <div class="mini-chart">
                        <canvas id="neutralChart"></canvas>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>悲观指标</h3>
                    <div class="value" id="pessimisticValue">0</div>
                    <div class="trend" id="pessimisticTrend">趋势: --</div>
                    <div class="mini-chart">
                        <canvas id="pessimisticChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 指标卡片网格 -->
        <div class="section indicators-section">
            <h2 class="section-title">情绪指标详情</h2>
            <div class="indicators-grid" id="indicatorsGrid">
                <!-- 指标卡片将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <!-- 引入Chart.js库和Annotations插件 -->
    <script src="chart.min.js"></script>
    <script src="chartjs-plugin-annotation.min.js"></script>
    <script>
        // 格式化日期函数
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            if (dateString.includes('/')) {
                return dateString;
            } else if (dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    return `${parseInt(parts[1])}/${parseInt(parts[2])}`;
                }
            }
            
            try {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                }
            } catch (e) {
                // 日期解析失败，返回原字符串
            }
            
            return dateString;
        }

        // 从CSV数据生成情绪分布数据
        function generateSentimentDistribution(parsedRows) {
            console.log('generateSentimentDistribution接收到的数据行数:', parsedRows.length);
            console.log('第一行数据:', parsedRows[0]);
            
            // 获取所有日期并排序
            const allDates = parsedRows.map(row => row[0]);
            console.log('所有日期:', allDates.slice(0, 10));
            
            const dates = [...new Set(allDates)]
                .filter(date => date && date.match(/^\d{4}-\d{2}-\d{2}$/))
                .sort();
            
            console.log('过滤后的日期:', dates);
            
            const distribution = dates.map(date => {
                const dayData = parsedRows.filter(row => row[0] === date && row[1] && row[1] !== '板块ETF流向');
                
                let optimistic = 0, neutral = 0, pessimistic = 0, missing = 0;
                
                dayData.forEach(row => {
                    const sentiment = row[2]; // 判断结果列
                    switch (sentiment) {
                        case '乐观': optimistic++; break;
                        case '中性': neutral++; break;
                        case '悲观': pessimistic++; break;
                        case '悲观/警示': pessimistic++; break;
                        default: missing++; break;
                    }
                });
                
                return { date, optimistic, neutral, pessimistic, missing };
            });
            
            return { overall_sentiment_distribution: distribution };
        }

        // CSV解析函数
        function parseCsvLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            if (!line || line.trim() === '') return [];
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result.map(field => {
                if (field.startsWith('"') && field.endsWith('"')) {
                    return field.substring(1, field.length - 1);
                }
                return field;
            });
        }

        // 加载指标详情数据
            async function loadIndicatorsData() {
                try {
                    const response = await fetch('enhanced_processed_sentiment_data.csv');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    
                    const text = await response.text();
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    
                    if (lines.length < 2) {
                        throw new Error('数据文件为空或格式错误');
                    }
                    
                    const parsedRows = lines.slice(1).map(line => parseCsvLine(line));
                    const dates = [...new Set(parsedRows.map(row => row[0]))].filter(date => date && date.match(/^\d{4}-\d{2}-\d{2}$/)).sort();
                    const latestDate = dates[dates.length - 1];
                    
                    const currentStateData = parsedRows.filter(row => row[0] === latestDate && row[1] && row[1] !== '板块ETF流向');
                    
                    let latestDataDate = latestDate;
                    
                    const indicators = currentStateData.map(row => ({
                        name: row[1] || '未知指标',
                        value: row[4] || 'N/A',
                        sentiment: getSentimentType(row[2]),
                        explanation: row[6] || '无解释',
                        detailedExplanation: row[6] || '',
                        thresholdExplanation: getThresholdExplanationForIndicator(row[1]),
                        dataDate: row[0]
                    }));
                    
                    // 为每个指标添加历史数据
                    for (const indicator of indicators) {
                        // 获取该指标的所有历史数据
                        const indicatorHistory = parsedRows
                            .filter(row => row.length >= 5 && row[1] === indicator.name)
                            .map(row => {
                                // 尝试获取真实数值，如果不是有效数字则使用情绪得分
                                let value;
                                let rawValue = row[4]; // 保存原始值（第4列：数值数据）
                                
                                if (row[4] && !isNaN(parseFloat(row[4]))) {
                                value = parseFloat(row[4]); // 使用真实数值数据（第4列）
                            } else if (row[3] && !isNaN(parseFloat(row[3]))) {
                                value = parseFloat(row[3]); // 使用情绪得分（第3列）
                                } else {
                                    // 如果没有有效数值，跳过这个数据点（不创建默认值）
                                    return null;
                                }
                                
                                return {
                                    date: row[0],
                                    value: value,
                                    rawValue: row[4] || null,
                                    sentiment: getSentimentType(row[2])
                                };
                            })
                            .filter(item => item !== null) // 过滤掉null值（缺失数据的数据点）
                            .sort((a, b) => new Date(a.date) - new Date(b.date));
                        
                        if (indicatorHistory.length > 0) {
                            indicator.data = indicatorHistory;
                            
                            if (indicator.value === 'N/A' || indicator.value === 'n/a' || !indicator.value || indicator.value.trim() === '') {
                                // 从历史数据中找到最近一个有效的完整数据
                                if (indicatorHistory.length > 1) {
                                    // 从all_sentiment_data.csv中找到前一个有效日期的完整数据
                                    const dates = [...new Set(parsedRows.map(row => row[0]))].sort();
                                    let validDateIndex = dates.length - 2; // 从倒数第二个日期开始查找
                                    
                                    while (validDateIndex >= 0) {
                                        const validDate = dates[validDateIndex];
                                        const validDateData = parsedRows.find(row => 
                                            row[0] === validDate && 
                                            row[1] === indicator.name && 
                                            row[4] && row[4] !== 'N/A' && row[4] !== 'n/a' && row[4].trim() !== ''
                                        );
                                        
                                        if (validDateData) {
                                            // 使用前一个有效日期的完整数据替换当前指标的所有数据
                                            indicator.value = validDateData[4]; // 数值（第4列）
                                            indicator.sentiment = getSentimentType(validDateData[2]); // 情绪判断
                                            
                                            // 更新解释信息
                                            indicator.explanation = validDateData[6] || '无解释'; // 当前状态解读作为每日最新指标解读（第6列）
                                            indicator.detailedExplanation = validDateData[6] || ''; // 当前状态解读（第6列）
                                            indicator.thresholdExplanation = getThresholdExplanationForIndicator(indicator.name); // 始终使用硬编码的判断标准
                                            indicator.previousDataDate = validDate; // 标记使用的日期
                                            indicator.dataDate = validDate; // 同时更新数据日期

                                            break;
                                        }
                                        validDateIndex--;
                                    }
                                }
                            }
                        }
                    }
                    
                    return indicators;
                } catch (error) {
                    return [];
                }
            }
        
        // 获取指标的历史数据
        function getIndicatorHistory(allParsedRows, indicatorName) {
            return allParsedRows
                .filter(values => values.length > 4 && values[1] === indicatorName && values[4]) // 确保数据完整且指标名称匹配
                .map(values => ({
                    date: values[0],
                    value: values[4]
                }))
                .sort((a, b) => new Date(a.date) - new Date(b.date));
        }
        
        // 根据指标名称获取固定的判断标准说明
        function getThresholdExplanationForIndicator(indicatorName) {
            // 为所有指标提供固定的判断标准
            if (indicatorName === 'CNN Fear & Greed') {
                return '乐观 (45-55): 市场情绪处于中性平衡点，投资者理性程度较高。中性 (25-44 或 56-75): 市场进入"恐惧"或"贪婪"状态，情绪偏向明显但未极端化。悲观/警示 (≤ 24 或 ≥ 76): 市场进入"极度恐惧"或"极度贪婪"状态，情绪极端化。';
            } else if (indicatorName === 'SPY 当日净流入金额') {
                return '乐观 (≥ +5亿): 大额净流入。中性 (-5亿 ~ +5亿): 资金进出平衡。悲观 (≤ -5亿): 大额净流出。';
            } else if (indicatorName === '避险资产流向 (TLT+GLD)') {
                return '乐观 (< -10亿)：避险流出。中性 (-10亿~+10亿)：平衡。悲观 (>+10亿)：避险流入。';
            } else if (indicatorName === 'VIX 指数 (恐慌指数)') {
                return '乐观 (< 20): 市场波动性低，投资者情绪平稳。中性 (20-30): 市场波动性中等。悲观 (> 30): 市场恐慌情绪高涨，波动性大。';
            } else if (indicatorName === 'Put/Call Ratio') {
                return '乐观 (< 0.7): 看涨期权交易活跃。中性 (0.7-1.0): 看涨看跌期权交易平衡。悲观 (> 1.0): 看跌期权交易活跃，避险情绪浓厚。';
            } else if (indicatorName === 'TRIN 指数 (Arms Index)') {
                return '乐观 (< 0.8): 市场买盘强劲。中性 (0.8-1.2): 市场买卖力量平衡。悲观 (> 1.2): 市场卖盘强劲。';

            } else if (indicatorName === '涨跌比 (A/D Ratio)') {
                return '乐观 (> 1.5): 上涨股票数量明显多于下跌股票。中性 (0.8-1.5): 上涨下跌股票数量相对平衡。悲观 (< 0.8): 下跌股票数量明显多于上涨股票。';
            } else if (indicatorName === '新高/新低比 (NH/NL)') {
                return '乐观 (> 10): 创新高股票远多于创新低股票。中性 (0.8-10): 创新高新低股票相对平衡。悲观 (< 0.5): 创新低股票远多于创新高股票。';
            } else if (indicatorName === '成交量趋势 (SPY)') {
                return '乐观 (> 1.2): 成交量明显放大。中性 (0.8-1.2): 成交量变化不大。悲观 (< 0.8): 成交量明显萎缩。';
            } else if (indicatorName === '美元指数 (DXY)') {
                return '乐观 (< 100): 美元走弱，有利于风险资产。中性 (100-103): 美元相对稳定。悲观 (> 103): 美元走强，不利风险资产。';
            } else if (indicatorName === '指数与均线 (S&P 500)') {
                return '乐观：价格 > MA20 & MA50。中性：价格徘徊于 MA20 附近。悲观：跌破 MA50。';
            }
            return ''; // 默认返回空字符串
        }
        
        // 根据判断结果获取情绪类型
        function getSentimentType(judgement) {
            if (!judgement || judgement.trim() === '') return 'missing';
            
            switch (judgement) {
                case '乐观': return 'optimistic';
                case '中性': return 'neutral';
                case '悲观': return 'pessimistic';
                case '悲观/警示': return 'pessimistic'; // 添加对悲观/警示的处理
                default: return 'missing';
            }
        }
        
        // 获取情绪标签文本
        function getSentimentLabel(sentiment) {
            switch (sentiment) {
                case "optimistic": return "乐观";
                case "neutral": return "中性";
                case "pessimistic": return "悲观";
                case "missing": return "缺失";
                default: return "未知";
            }
        }
        
        // 格式化指标值
        function formatValue(value, indicatorName) {
            if (!value || value === 'undefined' || value === 'null' || value === 'N/A' || value === 'n/a') return '';
            
            // 特殊处理指数与均线指标，只显示第一个数字（当前价格）
            if (indicatorName.includes('指数与均线')) {
                const firstValue = value.split(' / ')[0] || value.split('/')[0] || value;
                return parseFloat(firstValue).toFixed(2);
            }
            
            // 根据指标类型进行格式化
            if (indicatorName.includes('Ratio') || indicatorName.includes('比')) {
                return parseFloat(value).toFixed(2);
            } else if (indicatorName.includes('指数')) {
                return parseFloat(value).toFixed(2);
            } else if (indicatorName.includes('流入') || indicatorName.includes('流向')) {
                if (isNaN(parseFloat(value))) return value;
                const num = parseFloat(value);
                return num >= 1000 ? (num / 1000).toFixed(1) + 'B' : num.toFixed(1) + 'M';
            } else if (indicatorName === 'CNN Fear & Greed') {
                return parseFloat(value).toFixed(0);
            }
            
            return value;
        }

        // 计算情绪趋势
        function calculateTrend(data, sentimentType, recentDays = 5) {
            if (!data || data.length < 2) return { trend: 'neutral', change: 0, description: '数据不足' };
            
            // 获取最新值和5天前的值进行比较
            const latestValue = data[data.length - 1][sentimentType];
            const compareIndex = Math.max(0, data.length - recentDays - 1);
            const compareValue = data[compareIndex][sentimentType];
            
            const change = latestValue - compareValue;
            const days = Math.min(recentDays, data.length - 1);
            
            let trend = 'neutral';
            let description = '';
            
            if (change > 0) {
                trend = 'up';
                description = `近${days}日 +${change}`;
            } else if (change < 0) {
                trend = 'down';
                description = `近${days}日 ${change}`;
            } else {
                trend = 'neutral';
                description = `近${days}日 无变化`;
            }
            
            return { trend, change, description };
        }

        // 更新趋势显示
        function updateTrendDisplay(elementId, trendData) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            let trendText = '';
            let trendClass = '';
            
            switch (trendData.trend) {
                case 'up':
                    trendText = `${trendData.description} ↑`;
                    trendClass = 'trend-up';
                    break;
                case 'down':
                    trendText = `${trendData.description} ↓`;
                    trendClass = 'trend-down';
                    break;
                default:
                    trendText = `${trendData.description} →`;
                    trendClass = 'trend-neutral';
            }
            
            element.textContent = trendText;
            element.className = 'trend ' + trendClass;
        }

        // 创建情绪分布趋势图
        function createSentimentChart(data) {
            console.log('createSentimentChart接收到的数据:', data);
            
            // 检查canvas元素是否存在
            const canvasElement = document.getElementById('sentimentChart');
            if (!canvasElement) {
                console.error('找不到sentimentChart canvas元素!');
                return;
            }
            
            const ctx = canvasElement.getContext('2d');
            if (!ctx) {
                console.error('无法获取canvas 2d上下文!');
                return;
            }
            
            // 检查数据是否有效
            if (!data || !Array.isArray(data) || data.length === 0) {
                console.error('传入的数据无效:', data);
                return;
            }
            
            // 提取日期和各类情绪数量
            const labels = data.map(item => formatDate(item.date));
            const optimisticData = data.map(item => item.optimistic);
            const neutralData = data.map(item => item.neutral);
            const pessimisticData = data.map(item => item.pessimistic);
            const missingData = data.map(item => item.missing);
            
            console.log('图表数据:', { labels, optimisticData, neutralData, pessimisticData, missingData });
            
            // 检查Chart.js是否加载
            if (typeof Chart === 'undefined') {
                console.error('Chart.js库未加载!');
                return;
            }
            
            // 创建堆叠柱状图
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '乐观',
                            data: optimisticData,
                            backgroundColor: 'rgba(39, 174, 96, 0.7)',
                            borderColor: 'rgba(39, 174, 96, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '中性',
                            data: neutralData,
                            backgroundColor: 'rgba(243, 156, 18, 0.7)',
                            borderColor: 'rgba(243, 156, 18, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '悲观',
                            data: pessimisticData,
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '缺失',
                            data: missingData,
                            backgroundColor: 'rgba(149, 165, 166, 0.7)',
                            borderColor: 'rgba(149, 165, 166, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        title: {
                            display: true,
                            text: '美股情绪指标分布趋势'
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: '日期'
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: '指标数量'
                            },
                            min: 0
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
            
            console.log('情绪分布图表创建成功!');
        }
        
        // 创建测试图表
        function createTestChart() {
            console.log('创建测试图表...');
            
            const canvasElement = document.getElementById('sentimentChart');
            if (!canvasElement) {
                console.error('找不到sentimentChart canvas元素!');
                return;
            }
            
            const ctx = canvasElement.getContext('2d');
            
            // 测试数据
            const testData = {
                labels: ['2025-06-20', '2025-06-21', '2025-06-22', '2025-06-23'],
                datasets: [{
                    label: '乐观',
                    data: [3, 4, 2, 5],
                    backgroundColor: '#27ae60',
                    stack: 'stack1'
                }, {
                    label: '中性',
                    data: [2, 3, 4, 2],
                    backgroundColor: '#f39c12',
                    stack: 'stack1'
                }, {
                    label: '悲观',
                    data: [1, 2, 3, 1],
                    backgroundColor: '#e74c3c',
                    stack: 'stack1'
                }]
            };
            
            try {
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: testData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '测试图表 - 情绪分布'
                            },
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: '日期'
                                }
                            },
                            y: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: '指标数量'
                                }
                            }
                        }
                    }
                });
                console.log('测试图表创建成功!', chart);
            } catch (error) {
                console.error('创建测试图表失败:', error);
            }
        }

        // 创建小折线图
        function createMiniChart(canvasId, data, type, color) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`找不到canvas元素: ${canvasId}`);
                return;
            }
            
            // 获取最近5天的数据
            const recentData = data.slice(-5);
            const labels = recentData.map(item => {
                const date = new Date(item.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            const values = recentData.map(item => item[type] || 0);
            
            const ctx = canvas.getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: color,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return tooltipItems[0].label;
                                },
                                label: function(tooltipItem) {
                                    return `${type}: ${tooltipItem.formattedValue}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: false,
                            beginAtZero: true
                        }
                    },
                    elements: {
                        point: {
                            hoverRadius: 4
                        }
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        // 统一的迷你图绘制函数 (使用Chart.js和Annotations插件)
        function getThresholdsForIndicator(indicatorName) {
            if (indicatorName === 'VIX 指数 (恐慌指数)') {
                return {
                    'optimistic': [0, 20],
                    'neutral': [20, 30],
                    'pessimistic': [30, 100]
                };
            } else if (indicatorName === 'TRIN 指数 (Arms Index)') {
                return {
                    'optimistic': [0, 0.8],
                    'neutral': [0.8, 1.2],
                    'pessimistic': [1.2, 3.0]
                };
            } else if (indicatorName === 'CNN Fear & Greed') {
                return {
                    'optimistic': [45, 55],
                    'neutral': [25, 75],
                    'pessimistic': [0, 100]
                };
            } else if (indicatorName === '涨跌比 (A/D Ratio)') {
                return {
                    'optimistic': [1.5, 10],
                    'neutral': [0.8, 1.5],
                    'pessimistic': [0, 0.8]
                };
            } else if (indicatorName === '新高/新低比 (NH/NL)') {
                return {
                    'optimistic': [10, 100],
                    'neutral': [0.8, 10],
                    'pessimistic': [0, 0.5]
                };
            } else if (indicatorName === '成交量趋势 (SPY)') {
                return {
                    'optimistic': [1.2, 3],
                    'neutral': [0.8, 1.2],
                    'pessimistic': [0, 0.8]
                };
            } else if (indicatorName === 'SPY 当日净流入金额') {
                return {
                    'optimistic': [500, 10000],
                    'neutral': [-500, 500],
                    'pessimistic': [-10000, -500]
                };
            } else if (indicatorName === '避险资产流向 (TLT+GLD)') {
                return {
                    'optimistic': [-10000, -1000],
                    'neutral': [-1000, 1000],
                    'pessimistic': [1000, 10000]
                };
            } else if (indicatorName === '美元指数 (DXY)') {
                return {
                    'optimistic': [0, 100],
                    'neutral': [100, 103],
                    'pessimistic': [103, 200]
                };
            }
            
            // 默认阈值
            return {
                'optimistic': [0, 0.33],
                'neutral': [0.33, 0.66],
                'pessimistic': [0.66, 1]
            };
        }

        function drawMiniChart(canvasElement, indicatorData) {
            const ctx = canvasElement;
            const data = indicatorData.data || [];
            const indicatorName = indicatorData.name;
            
            // 特殊处理S&P 500指数
            if (indicatorName === '指数与均线 (S&P 500)') {
                drawSP500Chart(ctx, data, indicatorData);
                return;
            }
            
            // 过滤掉缺失数据的数据点，只保留有效数据
            const validData = data.filter(d => {
                const value = d.rawValue || d.value;
                return value && value !== 'N/A' && value !== 'n/a' && value.trim() !== '' && !isNaN(parseFloat(value));
            });
            
            // 提取日期和数值（只包含有效数据）
            const dates = validData.map(d => formatDate(d.date));
            const values = validData.map(d => parseFloat(d.rawValue || d.value));
            
            // 销毁旧的Chart.js实例以防止重复绘制
            if (ctx.chart) {
                ctx.chart.destroy();
            }
            
            // 计算数据范围，为了更好的视觉效果，扩展Y轴范围
            const minY = Math.min(...values.filter(v => !isNaN(v)));
            const maxY = Math.max(...values.filter(v => !isNaN(v)));
            const yRange = maxY - minY;
            
            // 根据指标类型设置适当的Y轴范围
            let paddedMinY, paddedMaxY;
            
            // 特殊处理某些指标的Y轴范围
            if (indicatorName === 'VIX 指数 (恐慌指数)') {
                // VIX指数通常在10-40之间，但可能会更高
                paddedMinY = Math.max(0, Math.min(10, minY - 5));
                paddedMaxY = Math.max(40, maxY + 5);
            } else if (indicatorName === 'CNN Fear & Greed') {
                // CNN Fear & Greed固定为0-100
                paddedMinY = 0;
                paddedMaxY = 100;
            } else if (indicatorName === 'TRIN 指数 (Arms Index)') {
                // TRIN指数通常在0.5-2.0之间，但可能会更高
                paddedMinY = Math.max(0, Math.min(0.5, minY - 0.2));
                paddedMaxY = Math.max(2.0, maxY + 0.2);
            } else if (indicatorName === 'Put/Call Ratio') {
                // Put/Call Ratio通常在0.5-1.5之间
                paddedMinY = Math.max(0, Math.min(0.5, minY - 0.1));
                paddedMaxY = Math.max(1.5, maxY + 0.1);
            } else if (indicatorName.includes('Ratio') || indicatorName.includes('比')) {
                // 其他比率类指标通常从0开始
                paddedMinY = Math.max(0, minY - yRange * 0.1);
                paddedMaxY = maxY + yRange * 0.1;
            } else if (indicatorName.includes('流入') || indicatorName.includes('流向')) {
                // 流入/流向可能有正负值
                const absMax = Math.max(Math.abs(minY), Math.abs(maxY));
                paddedMinY = -absMax * 1.1;
                paddedMaxY = absMax * 1.1;
            } else if (indicatorName.includes('指数') || indicatorName.includes('S&P') || indicatorName.includes('纳斯达克')) {
                // 指数类通常需要更紧凑的Y轴范围以显示变化
                paddedMinY = minY - yRange * 0.05;
                paddedMaxY = maxY + yRange * 0.05;
            } else {
                // 默认处理
                paddedMinY = Math.max(0, minY - yRange * 0.1);
                paddedMaxY = maxY + yRange * 0.1;
            }
            

            
            // 获取指标的阈值区间
            const thresholds = getThresholdsForIndicator(indicatorName);
            
            // 创建注释配置
            let annotations = {};
            
            // 默认处理其他指标
            if (false) {
                // 移除了S&P 500的特殊处理
                annotations['optimisticZone'] = {
                    type: 'box',
                    yMin: paddedMinY,
                    yMax: 0.7,
                    backgroundColor: 'rgba(39, 174, 96, 0.2)', // 乐观区域：绿色
                    borderWidth: 0,
                    borderColor: 'transparent',
                    xMin: 0,
                    xMax: dates.length - 1,
                    z: -1
                };
                
                annotations['neutralZone'] = {
                    type: 'box',
                    yMin: 0.7,
                    yMax: 1.0,
                    backgroundColor: 'rgba(243, 156, 18, 0.2)', // 中性区域：黄色
                    borderWidth: 0,
                    borderColor: 'transparent',
                    xMin: 0,
                    xMax: dates.length - 1,
                    z: -1
                };
                
                annotations['pessimisticZone'] = {
                    type: 'box',
                    yMin: 1.0,
                    yMax: paddedMaxY,
                    backgroundColor: 'rgba(231, 76, 60, 0.2)', // 悲观区域：红色
                    borderWidth: 0,
                    borderColor: 'transparent',
                    xMin: 0,
                    xMax: dates.length - 1,
                    z: -1
                };
            } else {
                // 其他指标按原来的阈值创建背景色块注释
                let annotationIndex = 0;
                for (const sentiment in thresholds) {
                    const [lower, upper] = thresholds[sentiment];
                    let backgroundColor;
                    
                    if (sentiment.includes('optimistic') || sentiment === 'optimistic') {
                        backgroundColor = 'rgba(39, 174, 96, 0.3)'; // 乐观色
                    } else if (sentiment.includes('neutral') || sentiment === 'neutral') {
                        backgroundColor = 'rgba(243, 156, 18, 0.3)'; // 中性色
                    } else if (sentiment.includes('pessimistic') || sentiment === 'pessimistic') {
                        backgroundColor = 'rgba(231, 76, 60, 0.3)'; // 悲观色
                    }
                    
                    annotations[`box${annotationIndex}`] = {
                        type: 'box',
                        yMin: lower !== null ? lower : paddedMinY,
                        yMax: upper !== null ? upper : paddedMaxY,
                        backgroundColor: backgroundColor,
                        borderWidth: 0,
                        borderColor: 'transparent',
                        xMin: 0,
                        xMax: dates.length - 1,
                        z: -1 // 确保背景色块在折线图下方
                    };
                    annotationIndex++;
                }
            }
            
            // 创建Chart.js配置
            const chartConfig = {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        data: values,
                        borderColor: '#2c3e50',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: '#2c3e50',
                        pointBorderColor: 'white',
                        pointBorderWidth: 2,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#e74c3c',
                        pointHoverBorderColor: 'white',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return tooltipItems[0].label;
                                },
                                label: function(tooltipItem) {
                                    const dataPoint = data[tooltipItem.dataIndex];
                                    let label = `${tooltipItem.formattedValue}`;
                                    
                                    // 如果有情绪类型，显示情绪类型
                                    if (dataPoint && dataPoint.sentiment) {
                                        label += ` [${getSentimentLabel(dataPoint.sentiment)}]`;
                                    }
                                    
                                    return label;
                                }
                            }
                        },
                        annotation: {
                            annotations: annotations
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { 
                                display: true,
                                color: 'rgba(255, 255, 255, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 5,
                                font: {
                                    size: 10
                                },
                                color: '#666'
                            }
                        },
                        y: {
                            display: true,
                            grid: { 
                                display: true,
                                color: 'rgba(255, 255, 255, 0.1)',
                                lineWidth: 1
                            },
                            suggestedMin: paddedMinY,
                            suggestedMax: paddedMaxY,
                            ticks: {
                                font: {
                                    size: 10
                                },
                                color: '#666'
                            }
                        }
                    },
                    elements: {
                        point: { radius: 2 }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            };
            
            // 特殊处理CNN Fear & Greed指标
            if (indicatorName === 'CNN Fear & Greed') {
                // 清空之前的注释配置
                annotations = {};
                
                // CNN Fear & Greed的阈值 - 根据用户提供的正确区间
                // 乐观（45-55），中性（25-44和56-75），悲观/警示（≤24或≥76）
                const cnn_thresholds = {
                    '悲观/警示 (≤24)': [0, 24, 'rgba(231, 76, 60, 0.3)'],
                    '中性 (25-44)': [25, 44, 'rgba(243, 156, 18, 0.3)'],
                    '乐观 (45-55)': [45, 55, 'rgba(39, 174, 96, 0.3)'],
                    '中性 (56-75)': [56, 75, 'rgba(243, 156, 18, 0.3)'],
                    '悲观/警示 (≥76)': [76, 100, 'rgba(231, 76, 60, 0.3)']
                };
                
                // 创建CNN Fear & Greed的背景色块注释
                annotationIndex = 0;
                for (const sentiment in cnn_thresholds) {
                    const [lower, upper, color] = cnn_thresholds[sentiment];
                    annotations[`box${annotationIndex}`] = {
                        type: 'box',
                        yMin: lower,
                        yMax: upper,
                        backgroundColor: color,
                        borderWidth: 0,
                        borderColor: 'transparent',
                        xMin: 0,
                        xMax: dates.length - 1,
                        z: -1 // 确保背景色块在折线图下方
                    };
                    annotationIndex++;
                }
                
                // 更新注释配置
                chartConfig.options.plugins.annotation.annotations = annotations;
                
                // 设置固定的Y轴范围
                chartConfig.options.scales.y.min = 0;
                chartConfig.options.scales.y.max = 100;
            }
            

            
            // 创建Chart.js实例
            ctx.chart = new Chart(ctx, chartConfig);
            
            return ctx.chart;
        }
        
        // 保留原始函数作为备份
        function drawLineChartWithZones(canvasElement, data, thresholds, colors, options = {}) {
            // 使用新的drawMiniChart函数替代
            const indicatorData = {
                name: '指标',
                data: data
            };
            return drawMiniChart(canvasElement, indicatorData);
        }

        // 指标分类定义
        const indicatorCategories = {
            '市场广度指标': {
                title: '市场广度指标 (上涨是否"健康")',
                indicators: ['涨跌比 (A/D Ratio)', '新高/新低比 (NH/NL Ratio)', 'TRIN 指数 (Arms Index)']
            },
            '情绪量化指标': {
                title: '情绪量化指标 (情绪是否"恐慌"或"贪婪")',
                indicators: ['VIX 指数', 'Put/Call Ratio', 'CNN Fear & Greed Index', 'VIX 指数 (恐慌指数)', 'CNN Fear & Greed']
            },
            '资金流向与动能指标': {
                title: '资金流向与动能指标 (资金的动向与交易活跃度)',
                indicators: ['成交量趋势 (SPY)', 'SPY 当日净流入金额', '避险资产流向 (TLT+GLD)']
            },
            '其它': {
                title: '其它指标',
                indicators: []
            }
        };

        // 根据指标名称获取分类
        function getIndicatorCategory(indicatorName) {
            for (const [category, config] of Object.entries(indicatorCategories)) {
                if (category === '其它') continue;
                if (config.indicators.some(name => indicatorName.includes(name.split(' ')[0]) || name.includes(indicatorName.split(' ')[0]))) {
                    return category;
                }
            }
            return '其它';
        }

        // 渲染指标卡片
        function renderIndicatorCards(indicators) {
            const gridContainer = document.getElementById('indicatorsGrid');
            gridContainer.innerHTML = '';
            
            // 按分类组织指标
            const categorizedIndicators = {};
            indicators.forEach(indicator => {
                const category = getIndicatorCategory(indicator.name);
                if (!categorizedIndicators[category]) {
                    categorizedIndicators[category] = [];
                }
                categorizedIndicators[category].push(indicator);
            });
            
            // 按预定义顺序渲染各分类
            const categoryOrder = ['市场广度指标', '情绪量化指标', '资金流向与动能指标', '其它'];
            
            categoryOrder.forEach(categoryKey => {
                const categoryIndicators = categorizedIndicators[categoryKey];
                if (!categoryIndicators || categoryIndicators.length === 0) return;
                
                // 创建分类标题
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                categoryTitle.innerHTML = `<h2>${indicatorCategories[categoryKey].title}</h2>`;
                gridContainer.appendChild(categoryTitle);
                
                // 创建该分类的指标容器
                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'category-indicators';
                
                categoryIndicators.forEach((indicator, index) => {
                const card = document.createElement('div');
                card.className = `indicator-card ${indicator.sentiment}`;
                
                // 卡片头部（指标名称和情绪标签）
                const header = document.createElement('div');
                header.className = 'indicator-header';
                
                const name = document.createElement('div');
                name.className = 'indicator-name';
                
                // 为SPY当日净流入金额和避险资产流向添加日期标注
                if (indicator.name === 'SPY 当日净流入金额' || indicator.name === '避险资产流向 (TLT+GLD)') {
                    // 显示实际数据的日期
                    const actualDataDate = indicator.previousDataDate || indicator.dataDate;
                    name.innerHTML = `${indicator.name}<br><span style="font-size: 0.8em; color: #777;">(${actualDataDate})</span>`;
                } else {
                    name.textContent = indicator.name;
                }
                
                const sentiment = document.createElement('div');
                sentiment.className = `indicator-sentiment sentiment-${indicator.sentiment}`;
                sentiment.textContent = getSentimentLabel(indicator.sentiment);
                
                header.appendChild(name);
                header.appendChild(sentiment);
                
                // 指标数值
                const value = document.createElement('div');
                value.className = 'indicator-value';
                const formattedValue = formatValue(indicator.value, indicator.name);
                
                // 如果值为空，显示数据缺失
                if (formattedValue === '') {
                    value.textContent = '数据缺失';
                    value.classList.add('value-na');
                } else {
                    value.textContent = formattedValue;
                }
                
                // 组装卡片基本元素
                card.appendChild(header);
                card.appendChild(value);
                

                
                // 添加每日最新指标解读（图表上方）
                if (indicator.detailedExplanation) {
                    const detailedTitle = document.createElement('div');
                    detailedTitle.style.cssText = 'font-weight: bold; color: #2c3e50; margin: 10px 0 5px 0; font-size: 0.85em;';
                    detailedTitle.textContent = '📊 每日最新指标解读';
                    card.appendChild(detailedTitle);
                    
                    const detailedExplanation = document.createElement('div');
                    detailedExplanation.className = 'detailed-explanation';
                    detailedExplanation.style.fontSize = '1.05em';
                    detailedExplanation.innerHTML = indicator.detailedExplanation;
                    card.appendChild(detailedExplanation);
                }
                
                // 迷你图表（显示历史数据）
                const miniChart = document.createElement('div');
                miniChart.className = 'mini-chart';
                
                // 只有当指标有历史数据时才显示图表
                if (indicator.data && indicator.data.length > 0) {
                    // 创建Canvas元素用于绘制图表
                    const canvas = document.createElement('canvas');
                    canvas.width = 300;
                    canvas.height = 100;
                    miniChart.appendChild(canvas);
                    
                    // 使用drawMiniChart函数绘制历史数据图表
                    setTimeout(() => {
                        drawMiniChart(canvas, indicator);
                    }, 0);
                } else {
                    miniChart.style.display = 'none'; // 如果没有历史数据则隐藏
                }
                
                card.appendChild(miniChart);
                
                // 添加判断标准（图表下方）
                if (indicator.thresholdExplanation) {
                    const thresholdTitle = document.createElement('div');
                    thresholdTitle.style.cssText = 'font-weight: bold; color: #2c3e50; margin: 10px 0 5px 0; font-size: 0.85em;';
                    thresholdTitle.textContent = '📋 判断标准';
                    card.appendChild(thresholdTitle);
                    
                    const thresholdExplanation = document.createElement('div');
                    thresholdExplanation.className = 'threshold-explanation';
                    thresholdExplanation.innerHTML = indicator.thresholdExplanation;
                    card.appendChild(thresholdExplanation);
                }
                
                categoryContainer.appendChild(card);
                });
                
                gridContainer.appendChild(categoryContainer);
            });
        }
        


        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 从CSV文件加载数据
                const response = await fetch('enhanced_processed_sentiment_data.csv');
                const csvText = await response.text();
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                console.log('CSV总行数:', lines.length);
                console.log('CSV头部:', lines[0]);
                
                const parsedRows = lines.slice(1).map(line => parseCsvLine(line));
                console.log('解析后的前3行数据:', parsedRows.slice(0, 3));
                
                // 检查数据结构
                if (parsedRows.length > 0) {
                    console.log('第一行数据结构:', {
                        '列0(日期)': parsedRows[0][0],
                        '列1(指标名称)': parsedRows[0][1], 
                        '列2(判断结果)': parsedRows[0][2],
                        '列3(情绪得分)': parsedRows[0][3],
                        '列4(数值数据)': parsedRows[0][4]
                    });
                }
                
                // 生成情绪分布数据
                const sentimentData = generateSentimentDistribution(parsedRows);
                console.log('生成的情绪分布数据:', sentimentData);
                
                if (sentimentData && sentimentData.overall_sentiment_distribution.length > 0) {
                    // 更新最后更新时间
                    const lastDate = sentimentData.overall_sentiment_distribution[sentimentData.overall_sentiment_distribution.length - 1].date;
                    document.getElementById('lastUpdate').textContent = `最后更新: ${lastDate}`;
                    
                    // 创建情绪分布趋势图
                    createSentimentChart(sentimentData.overall_sentiment_distribution);
                    
                    // 更新情绪统计卡片
                    const latestData = sentimentData.overall_sentiment_distribution[sentimentData.overall_sentiment_distribution.length - 1];
                    document.getElementById('optimisticValue').textContent = latestData.optimistic;
                    document.getElementById('neutralValue').textContent = latestData.neutral;
                    document.getElementById('pessimisticValue').textContent = latestData.pessimistic;
                    
                    // 计算并显示趋势
                    const optimisticTrend = calculateTrend(sentimentData.overall_sentiment_distribution, 'optimistic');
                    const neutralTrend = calculateTrend(sentimentData.overall_sentiment_distribution, 'neutral');
                    const pessimisticTrend = calculateTrend(sentimentData.overall_sentiment_distribution, 'pessimistic');
                    
                    updateTrendDisplay('optimisticTrend', optimisticTrend);
                    updateTrendDisplay('neutralTrend', neutralTrend);
                    updateTrendDisplay('pessimisticTrend', pessimisticTrend);
                    
                    // 创建小折线图
                    createMiniChart('optimisticChart', sentimentData.overall_sentiment_distribution, 'optimistic', '#27ae60');
                    createMiniChart('neutralChart', sentimentData.overall_sentiment_distribution, 'neutral', '#f39c12');
                    createMiniChart('pessimisticChart', sentimentData.overall_sentiment_distribution, 'pessimistic', '#e74c3c');
                } else {
                    console.warn('情绪数据为空或无效，创建测试图表');
                    // 创建测试图表
                    createTestChart();
                    
                    // 更新情绪统计卡片
                    const latestData = sentimentData.overall_sentiment_distribution[sentimentData.overall_sentiment_distribution.length - 1];
                    document.getElementById('optimisticValue').textContent = latestData.optimistic;
                    document.getElementById('neutralValue').textContent = latestData.neutral;
                    document.getElementById('pessimisticValue').textContent = latestData.pessimistic;
                    
                    // 计算并显示趋势
                    const optimisticTrend = calculateTrend(sentimentData.overall_sentiment_distribution, 'optimistic');
                    const neutralTrend = calculateTrend(sentimentData.overall_sentiment_distribution, 'neutral');
                    const pessimisticTrend = calculateTrend(sentimentData.overall_sentiment_distribution, 'pessimistic');
                    
                    updateTrendDisplay('optimisticTrend', optimisticTrend);
                    updateTrendDisplay('neutralTrend', neutralTrend);
                    updateTrendDisplay('pessimisticTrend', pessimisticTrend);
                }
                
                // 加载指标详情数据
                const indicators = await loadIndicatorsData();
                
                if (indicators && indicators.length > 0) {
                    renderIndicatorCards(indicators);
                } else {
                    const gridContainer = document.getElementById('indicatorsGrid');
                    if (gridContainer) {
                        gridContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">暂无指标数据</p>';
                    }
                }
            } catch (error) {
                console.error('加载数据时出错:', error);
                console.error('错误堆栈:', error.stack);
                
                // 显示错误信息给用户
                 const errorDiv = document.createElement('div');
                 errorDiv.style.cssText = 'background: #ffebee; color: #c62828; padding: 15px; margin: 20px; border-radius: 5px; border: 1px solid #ef5350;';
                 errorDiv.innerHTML = `<strong>数据加载失败:</strong> ${error.message}`;
                 document.body.insertBefore(errorDiv, document.body.firstChild);
                 
                 const gridContainer = document.getElementById('indicatorsGrid');
                if (gridContainer) {
                    gridContainer.innerHTML = '<p style="text-align: center; color: #f44336; padding: 20px;">数据加载失败，请检查文件路径</p>';
                }
            }
        });
        
        // 专门处理S&P 500指数的图表绘制函数
        function drawSP500Chart(ctx, data, indicatorData) {
            // 销毁旧的Chart.js实例以防止重复绘制
            if (ctx.chart) {
                ctx.chart.destroy();
            }
            
            // 过滤掉缺失数据的数据点，只保留有效数据
            const validData = data.filter(d => {
                const value = d.rawValue || d.value;
                return value && value !== 'N/A' && value !== 'n/a' && value.trim() !== '';
            });
            
            if (validData.length === 0) {
                return;
            }
            
            // 解析S&P 500数据：格式为 "价格 / MA20 / MA50"
            const dates = validData.map(d => formatDate(d.date));
            const sp500Values = [];
            const ma20Values = [];
            const ma50Values = [];
            const sentiments = validData.map(d => d.sentiment);
            
            validData.forEach(d => {
                const value = d.rawValue || d.value;
                const parts = value.split('/');
                if (parts.length >= 3) {
                    // 斜杠分隔格式：价格/MA20/MA50
                    sp500Values.push(parseFloat(parts[0].trim()));
                    ma20Values.push(parseFloat(parts[1].trim()));
                    ma50Values.push(parseFloat(parts[2].trim()));
                } else {
                    // 尝试解析逗号分隔的格式
                    const commaParts = value.split(',');
                    if (commaParts.length >= 3) {
                        // 逗号分隔格式：价格,MA20,MA50
                        sp500Values.push(parseFloat(commaParts[0].trim()));
                        ma20Values.push(parseFloat(commaParts[1].trim()));
                        ma50Values.push(parseFloat(commaParts[2].trim()));
                    } else {
                        // 单一数值格式：只有价格，需要从解释中提取MA20和MA50
                        const price = parseFloat(value.trim());
                        if (!isNaN(price)) {
                            sp500Values.push(price);
                            
                            // 从解释文本中提取MA20和MA50数值
                            const explanation = d.explanation || indicatorData.explanation || '';
                            const ma20Match = explanation.match(/MA20\((\d+\.\d+)\)/);
                            const ma50Match = explanation.match(/MA50\((\d+\.\d+)\)/);
                            
                            if (ma20Match && ma50Match) {
                                ma20Values.push(parseFloat(ma20Match[1]));
                                ma50Values.push(parseFloat(ma50Match[1]));
                            } else {
                                // 如果无法提取MA值，使用价格作为近似值（这样至少图表能显示）
                                ma20Values.push(price * 0.99); // MA20通常略低于当前价格
                                ma50Values.push(price * 0.96); // MA50通常更低
                            }
                        }
                    }
                }
            });
            
            // 计算Y轴范围
            const allValues = [...sp500Values, ...ma20Values, ...ma50Values].filter(v => !isNaN(v));
            const minY = Math.min(...allValues);
            const maxY = Math.max(...allValues);
            const yRange = maxY - minY;
            const paddedMinY = minY - yRange * 0.02;
            const paddedMaxY = maxY + yRange * 0.02;
            
            // 获取最新的情绪状态用于背景颜色
            const latestSentiment = sentiments[sentiments.length - 1];
            let backgroundColor = 'rgba(255, 255, 255, 0.1)'; // 默认背景
            
            if (latestSentiment === 'optimistic') {
                backgroundColor = 'rgba(39, 174, 96, 0.1)'; // 绿色背景
            } else if (latestSentiment === 'neutral') {
                backgroundColor = 'rgba(243, 156, 18, 0.1)'; // 黄色背景
            } else if (latestSentiment === 'pessimistic') {
                backgroundColor = 'rgba(231, 76, 60, 0.1)'; // 红色背景
            }
            
            // 创建背景注释
            const annotations = {
                backgroundZone: {
                    type: 'box',
                    yMin: paddedMinY,
                    yMax: paddedMaxY,
                    backgroundColor: backgroundColor,
                    borderWidth: 0,
                    borderColor: 'transparent',
                    xMin: 0,
                    xMax: dates.length - 1,
                    z: -1
                }
            };
            
            // 创建Chart.js配置
            const chartConfig = {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'S&P 500',
                            data: sp500Values,
                            borderColor: '#2c3e50',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: '#2c3e50',
                            pointBorderColor: 'white',
                            pointBorderWidth: 2,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#e74c3c',
                            pointHoverBorderColor: 'white',
                            pointHoverBorderWidth: 2
                        },
                        {
                            label: 'MA20',
                            data: ma20Values,
                            borderColor: '#3498db',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 2,
                            pointBackgroundColor: '#3498db',
                            pointBorderColor: 'white',
                            pointBorderWidth: 1,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'MA50',
                            data: ma50Values,
                            borderColor: '#e67e22',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 2,
                            pointBackgroundColor: '#e67e22',
                            pointBorderColor: 'white',
                            pointBorderWidth: 1,
                            borderDash: [10, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 10
                                },
                                usePointStyle: true,
                                padding: 10
                            }
                        },
                        title: { display: false },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return tooltipItems[0].label;
                                },
                                label: function(tooltipItem) {
                                    const datasetLabel = tooltipItem.dataset.label;
                                    const value = tooltipItem.formattedValue;
                                    return `${datasetLabel}: ${value}`;
                                },
                                afterBody: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    const sentiment = sentiments[index];
                                    if (sentiment) {
                                        return [`情绪: ${getSentimentLabel(sentiment)}`];
                                    }
                                    return [];
                                }
                            }
                        },
                        annotation: {
                            annotations: annotations
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { 
                                display: true,
                                color: 'rgba(255, 255, 255, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 5,
                                font: {
                                    size: 10
                                },
                                color: '#666'
                            }
                        },
                        y: {
                            display: true,
                            grid: { 
                                display: true,
                                color: 'rgba(255, 255, 255, 0.1)',
                                lineWidth: 1
                            },
                            suggestedMin: paddedMinY,
                            suggestedMax: paddedMaxY,
                            ticks: {
                                font: {
                                    size: 10
                                },
                                color: '#666'
                            }
                        }
                    },
                    elements: {
                        point: { radius: 2 }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            };
            
            // 创建图表
            ctx.chart = new Chart(ctx, chartConfig);
        }
    </script>
</body>
</html>